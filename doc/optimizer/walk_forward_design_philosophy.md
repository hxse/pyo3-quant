# 向前滚动测试设计理念

> **核心定位**：解决参数过拟合问题，验证优化参数在样本外数据上的真实表现，提供可信的绩效预期。

---

## 1. 核心问题：过拟合

参数优化的致命陷阱是**过拟合**——在历史数据上表现完美的参数，在未来数据上往往惨败。

传统回测只能告诉你"参数在过去表现如何"，却无法预测"参数在未来表现如何"。

**向前滚动测试（Walk-Forward Testing）** 通过模拟"用过去优化，用未来验证"的真实流程，提供更可靠的绩效估计。

---

## 2. 窗口结构

```
┌──────────── 训练期 ────────────┐┌──── 测试期 ────┐
│         优化参数               ││   验证参数     │
└────────────────────────────────┘└────────────────┘
                    ↓ 滚动步长
┌──────────── 训练期 ────────────┐┌──── 测试期 ────┐
│         优化参数               ││   验证参数     │
└────────────────────────────────┘└────────────────┘
                    ↓
              ...重复...
```

*   **训练期**：在此区间运行参数优化，找到最优参数。
*   **测试期**：用训练期找到的参数，在测试期运行回测，评估样本外表现。
*   **滚动步长**：每次向前移动的数据量，控制窗口重叠程度。

---

## 3. 设计选择

### 3.1 只继承上一窗口

向前滚动引擎将上一窗口的 Top K 参数作为下一窗口优化器的先验（初始权重中心）。

**为什么不累积所有历史？**

*   **自然遗忘**：市场结构会变化，远古参数可能已失效。
*   **简单即健壮**：无需设计复杂的历史权重衰减机制。
*   **更快适应**：如果某个窗口表现差，其影响只持续一个窗口。

### 3.2 精确测试集评估

测试集评估使用**完全独立的回测**，而非优化器内部的近似结果。

这样确保测试集绩效是"真实的样本外表现"，没有任何信息泄露。

### 3.3 持续探索的自然复用

即使继承了上一窗口的权重先验，每轮仍保留固定比例的 LHS 全局采样（`explore_ratio`）。

**这是优化器的核心设计在向前滚动中的自然复用**：

*   上一窗口的最优参数可能已经失效（市场结构变化）。
*   新窗口的全局探索点有机会发现新的有效参数。
*   避免"老参数传染"导致的渐进失效。

这保证了：

*   即使先验集中在错误区域，仍有机会发现新的好参数。
*   防止"过度继承"导致的搜索空间塌缩。

---

## 4. 参数配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `train_ratio` | 0.60 | 训练窗口长度（占总数据比例） |
| `test_ratio` | 0.20 | 测试窗口长度（占总数据比例） |
| `step_ratio` | 0.10 | 滚动步长（占总数据比例） |
| `inherit_prior` | true | 是否从上一窗口继承权重先验 |

---

## 5. 输出指标

*   **每个窗口**：
    *   训练集最优参数
    *   训练集绩效指标（如 Calmar Ratio）
    *   测试集绩效指标（样本外验证）
*   **汇总**：
    *   所有窗口测试集绩效的平均值
    *   可选：标准差、最差窗口等

---

## 6. 与单次优化的对比

| 维度 | 单次优化 | 向前滚动 |
|------|----------|----------|
| **过拟合风险** | 高 | 低 |
| **绩效可信度** | 未知 | 可信 |
| **计算成本** | 低 | 高（N 个窗口） |
| **适用场景** | 探索、原型 | 验证、生产 |

---

## 7. 适用场景

*   **参数稳健性验证**：确认优化参数在多个时期都有效。
*   **策略年化收益估计**：用测试期绩效均值作为未来收益预期。
*   **参数生命周期评估**：通过各窗口绩效变化，判断参数是否在衰减。

---

## 8. 不适用场景

*   **长线持仓策略**：一笔交易可能跨越多个窗口，切分会中断持仓逻辑。
*   **数据量极少**：窗口太小会导致优化和测试都不充分。
*   **快速原型迭代**：向前滚动计算成本高，不适合频繁快速尝试。

---

## 9. 设计哲学总结

1.  **样本外为王**：历史绩效不代表未来，只有样本外表现才有参考价值。
2.  **模拟真实流程**：向前滚动模拟了"用过去预测未来"的真实交易流程。
3.  **接受不确定性**：即使向前滚动验证通过，未来仍可能失效；向前滚动只是提高信心，不是保证。

本模块与优化器模块解耦，可独立使用。组合使用时，形成完整的"优化-验证"闭环。
