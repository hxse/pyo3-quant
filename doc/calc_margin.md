# 如何设计杠杆手续费
## 复杂方案
方案量化回测, 模拟手续费
预期盈亏 = (价格涨跌百分比 - 百分比手续费) * 当前余额(USD) * 资金比例 - 固定手续费 * 资金比例
预期盈亏百分比 = 预期盈亏 / 当前余额(USD)

加密货币
参数, 百分比手续费, 浮点数, 估算交易所手续费和价差滑点等潜在成本
参数, 固定手续费, 直接设为0
参数, 资金比例, 大于等于0的浮点数, 大于1表示杠杆, 小于1表示部分仓位
参数, 最大资金比例, 大于等于0的浮点数, 根据情况设置
参数, 保证金比例, 浮点数, 留空, 不需要

传统期货
把当前余额(USD)理解成下单一手用的钱
参数, 百分比手续费, 直接设为0
参数, 固定手续费, 浮点数, 美元, 估算下单一手的预期费用USD
参数, 资金比例, 浮点数, 但限制为大于等于0的整数, 表示下单手数
参数, 最大资金比例, 浮点数, 但限制为大于等于0的整数, 表示最大交易手数, 根据情况设置
参数, 保证金比例, 浮点数, 判断是否爆仓, 如果螺纹钢期货15倍杠杆, 就是0.15

判断已爆仓 = 预期盈亏百分比的亏损的绝对值 > 保证金比例
如果爆仓就把当前余额归零, 不爆仓就等于预期余额
判断爆仓不需要考虑其他仓位, 回测只跟踪一个仓位

## 简单方案
预期盈亏 = (价格涨跌百分比 - 百分比手续费) * 当前余额(USD) - 固定手续费

预期盈亏百分比 = 预期盈亏 / 当前余额(USD)

可承受最大杠杆 = 1 / 最大回撤百分比
杠杆后最大总回报百分比(乐观) = 最大可承受杠杆 * 无杠杆回测的总回报百分比

因为最大回撤百分比已经包含手续费的影响了, 可以直接除, 不用再算手续费了
价差滑点网络波动等可以估算在手续费里,无需复杂处理

如归是加密货币, 可以直接把杠杆设置成可承受最大杠杆
如果是期货, 下单手数 = 最大可承受杠杆 / 该品种实际杠杆倍数

仓位控制,只影响停止开仓和恢复开仓,不会加仓减仓,也不会加减杠杆,所以确保了最大回测的计算不包含杠杆

安全系数可以用来降低杠杆, 也可以用来增加本金, 避免交易所强平
比如, 杠杆 * 0.8 或者 本金 * 1.2

## 为什么选择简单方案
为什么选择选择简单方案, 因为复杂方案, 最大回撤已经包含杠杆了, 不能作数了
简单方案的话, 只能暂停开仓, 不能加仓减仓, 因为会包含杠杆, 会让手续费变复杂

开仓控制:
1. 参数, 浮点, 帐户净值下跌历史高点的20%, 停止开仓
2. 参数, 浮点, 帐户净值历史高点到当前之间所有点, 回弹最高点和最低点的50%, 回复开仓
2. 参数, sma周期, 帐户净值下跌超过其自身sma, 就停止开仓, 上涨超过就恢复开仓
