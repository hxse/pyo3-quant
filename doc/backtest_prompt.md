文档 @/doc/backtest.md


这次任务的最终目的是彻底实现方案, 确保回测模块的实际实现, 而不只是手脚架, 并且和方案逻辑和细节都要保持一致
回测模块路径是 src/backtest_engine/backtester, 只关注这个文件里的代码就好, 这个文件夹之外的代码, 一般不用关注


还涉及到几个外部文件, 这几个文件, 一般没什么必要改动就别改, 改的话, 也只改跟回测模块相关的, 不要改无关的
@/src/data_conversion/input/data_dict.rs
@/src/data_conversion/input/param_set.rs
@/src/backtest_engine/indicators/atr.rs
@/src/error


关于 Param:
Param 结构体有多个字段（initial_value, min, max, initial_min, initial_max, step, initial_step, optimize, log_scale）被定义但从未使用
这个Param不要动, 这是给优化器用的, 跟回测模块无关


# 注意事项:
1. src/backtest_engine/backtester/mod.rs 可以从这个入口文件进行递归检查
1.  src/backtest_engine/backtester/mod.rs 中的run_backtest，py_run_backtest 这两个函数是兼容性入口函数, 是重要的面向外部的约定和接口函数, 并非旧代码遗留, 这个函数不可改, 不可删, 不可动
2. 记住, 只修复 src/backtest_engine/backtester 这个模块的静态编译警告和报错, 模块外的代码都不要动, 只关注这个模块就行了
3. 如果子任务需要警告和报错信息, 可以用cargo check命令自行获取
4. 测试静态编译, 不要执行cargo test和cargo build, 只执行cargo check就够了, 其他都不要执行
5. 尽量避免clone, 影响性能, 尽量用不clone的
6. 不要用unsafe的方式编写代码
7. 无需写测试代码, 只需要把代码正确优雅的实现, 和方案逻辑一致, 没有冗余, 没有警告和报错, 就行了


# 阶段1, 项目诊断, 给出相关建议
1. 阅读md方案文档, 从mod.rs入手, 深入项目每一个相关源代码, 诊断当前项目是否有问题, 是否和方案逻辑细节不一致, 是否有冗余代码, 是否有旧代码遗留(两个相似方法并行, 混乱矛盾), 是否有未调用的方法
2. 对项目进行一个诊断, 把问题排列出优先级, 这个优先级的划分, 是根据是否在架构的时候容易引起混乱划分的
   1. 旧代码遗留是最高优先级(两个相似方法并行,用不同的方法解决同一个问题)
   2. 未调用的方法和变量等
   3. 冗余代码
   4. 基础架构错误或不合适, 分为几点
      1. 架构无法支撑方案的复杂逻辑, 不合适需要重构, 最高优先级
      2. 架构明显不够高内聚, 逻辑太分散, 分散的乱七八糟也不行啊, 难以维护
      3. 架构明显不够低耦合, 需要做好模块化调用
      4. 单文件太大需要拆分, 最低优先级, 单文件代码超过300行, 一定要拆分, 超过200行, 建议拆分
   5. 不必要的clone, 拖垮性能
   6. 逻辑细节完善是最后的优先级

3. 还要评估, 当前架构是否能承载方案的细节逻辑, 是否有必要进行重构, (谨慎对待重构, 重构的成本太高了, 除非有明确的理由,  非必要不重构,)
4. 还要注意, 超过300行的代码要拆分, 不能搞出太大的文件, 不方便维护, 最好超过200行就开始拆分, 预期未来代码会膨胀的, 也可以提前拆分
5. 这个诊断报告很重要, 其指出的问题和建议, 会被后续阶段参考


# 阶段2, 架构优化, 做减法, 清理和调整基础架构
1. 禁止用allow去掩盖警告, 应该用逻辑分析从根本上解决警告, _前下划线消除警告也不妥, 道理和allow一样, 有些警告是良性的, 比如有未来计划会使用的,现在未用到,可以添加注释说明
2. 如果警告来自于旧代码遗留, 并且存在两份功能类似的代码, 那么删除一份, 只保留一份, 做到一个问题, 只用一个方法去解决, 绝对不能搞出两套方法来, 实现应该简单优雅
3. 如果警告来自于, 该功能未被调用, 那么把它正确调用就行了, 不要删除有用的代码, 只删除矛盾混乱的代码
4. 如果存在冗余代码, 也应当一并删除
5. 基础架构问题, 本阶段以清理和整理为主, 比如把冗余代码进行删除, 把难以维护的代码进行合并和拆分(高内聚低耦合), 若架构不能承载方案的逻辑,则需要调整架构
6. 任何架构调整, 都需要考虑是否有旧代码遗留需要清楚,避免新增调整后又带来一堆新的旧代码遗留问题
7. 逻辑细节问题, 在本阶段不进行解决, 放到后面阶段进行解决,本阶段允许把逻辑细节留空
8. 本阶段, 目标只是解决所有编译报错和警告, 清理旧代码遗留问题, 清理冗余代码, 正确引用忘记引用的代码, 这才是第一阶段的主要目标
9. 本阶段, 哪怕功能也不完整也没关系, 可以留空, 在后续阶段会完善, 本阶段重点在于清理, 保证一个功能一个方法, 不要出现一个功能两个方法, 或者有忘记调用的方法, 或者有冗余代码
10. 本阶段主要是做减法, 避免引起混乱, 功能不完整可以留空, 最终要清除掉所有警告和编译问题
11. 需要保证整体架构符合方案文档doc/backtest.md， (某些细节在本阶段可以留空)


# 阶段3, 是做加法, 是完善细节
1. 前面的阶段可以确保, 有一个留空的架构, 并且冗余代码都被清理, 所以这个架构开始完善细节
2. 在完善代码的时候, 必须要去思考, 如果跟已有代码冲突的话, 就要彻底清空旧代码遗留, 不要再搞出旧代码遗留问题, 要把代码写干净, 否则会引起混乱
3. 规划原则应该是, 减法优先于加法, 确保不混乱的基础上, 慢慢添加代码
4. 如果在实际编写的过程中, 发现了严重架构问题(理论架构可行, 实际写的时候发现不行), 最好停止整个任务的运行, 让用户去处理吧
5. 最后依然要清除所有的静态警告和编译报错
6. 重点, 理论上这个阶段应该已经有基础架构了,只是完善细节,所以在方案规划阶段应该注意,应该调用已有方法和变量,而不是创建新的方法和变量,如果缺少已有对象,应该报错退出,退回"架构优化阶段", 不要在错误的地方下功夫
7. 如果过程中,发现任何理论上存在的架构, 实际上存在, 或者理论上够用的架构, 实际上不够用, 那么直接报错退出, 然后重新回到"架构优化阶段", 不要在错误的架构上下功夫
8. 如果过程中发现了存在严重的旧代码遗留(两个相似功能并行),或者大量冗余代码,应该报错退出,然后重新回到最初的"架构优化阶段",不要在错误的架构上下功夫


# 要稳步推进:
1. 这是个大型项目, 必须稳步推进, 需要谨慎对待, 马虎不得
2. 先调用arch子任务进行大阶段的规划(宏观), 然后每个阶段还要再调用arch子任务进行小任务的规划(具体)
3. 在每个大阶段结束后, 应该确保没有任何静态警告和编译错误, 这在方案设计阶段就该理论上保证, 在实际编程到阶段尾声, 也应该进行静态检测和修复
4. 保证每次调用code子任务, 都要先调用arch子任务进行规划, 如果是编译问题, 可以让子任务debug去规划
5. 子任务arch只返回方案, 不进行修改代码, 子任务debug负责处理静态警告和编译问题, 同样只返回方案, 不进行修改代码, 由子任务code执行代码修改
6. 最初的项目诊断阶段允许宏观的指出问题,只要带上相关文件和变量名和代码行数就好,无需示例代码
7. 后续的子任务arch和debug, 必须返回明确详细清晰具体的可执行的方案, 降低子任务code执行出错的概率, 要有明确的文件名,变量名,函数名,所在函数名,相关代码行数,如果复杂的话,还要有相关代码
8. 每次制定方案的时候(包括架构设计方案,修复编译方案,代码修改方案), 都要明确告诉子任务去阅读一遍文档, 确保规划符合文档意图, 而且需要实际深入源代码去分析问题, 不能凭空想象只看表面


# todolist
  * 根据情况子任务code执行可以细化成多个阶段, 所以用.x
  * 1. 项目诊断阶段, 调用arch去规划方案, 不执行代码修改
    * 返回的诊断报告,必须详细,包含相关代码的所在文件名和行数和变量名
  * 2. 架构优化阶段, 调用arch去规划方案, 不执行代码修改
    * 注意: 在发起这个子任务请求时, 需要包含诊断报告的完整上下文, 因为子任务无法自动获取上下文
    * 要求子任务首先阅读文档, 规划的方案必须符合文档 doc/backtest.md
    * 返回的规划方案,必须详细,包含相关代码的所在文件名和行数和变量名
  * 2.x 架构优化阶段, 调用子任务code执行代码修改
  * 3. 完善细节阶段, 调用arch去规划方案, 不执行代码修改
    * 要求子任务首先阅读文档, 规划的方案必须符合文档 doc/backtest.md
    * 返回的规划方案,必须详细,包含相关代码的所在文件名和行数和变量名
  * 3.x 完善细节阶段, 调用子任务code执行代码修改
  * 4 再运行一次, 架构优化阶段, 调用arch去规划方案, 不执行代码修改
    * 要求子任务首先阅读文档, 规划的方案必须符合文档 doc/backtest.md
    * 返回的规划方案,必须详细,包含相关代码的所在文件名和行数和变量名
  * 4.x 再运行一次, 架构优化阶段, 调用子任务code执行代码修改
