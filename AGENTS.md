# AGENTS.md - 协作守则与技术指南

本项目是一个基于 **PyO3** 开发的高性能量化交易回测框架。**Rust** 承载核心计算逻辑（如指标计算、回测核心），**Python** 负责上层策略逻辑与灵活调用。

## 1. 沟通与语言规范
*   **全程中文沟通**：所有分析、交流、回复、沟通、Plan 和报告均必须使用中文。
*   **代码与注释**：代码本身（变量名、函数名、类名等）应使用**英文**以保持专业性；代码注释必须使用**中文**以确保易读性和审阅效率。
*   **强制注释**：写代码时必须带上注释，提高可阅读性，让审阅与后续维护更易懂。

## 2. 方案讨论与 Plan 优先
*   **严禁盲目行动**：除非得到明确的执行命令，否则不要直接修改代码。应先深入讨论方案，或同步更新 Plan。
*   **杜绝「氛围编程」**：追求充分的方案讨论后再执行。细节必须讨论清楚，避免胡乱执行导致的代码质量下降。不搞氛围编程，要搞就搞高质量的方案讨论，再执行。
*   **Plan 的灵魂地位**：
    *   **增量更新**：更新 `implementation plan` 时应采用增量方式，仅删除过时的内容，确保 Plan 的连贯性与完整性。
    *   **示例驱动**：修改或创建 Plan 时，应附带关键的示例代码（Snippet），提高方案的可执行性，减少出错概率。

## 3. 开发工作流
*   **Just 命令优先**：务必先阅读 `justfile`，优先使用 `just` 运行相关指令，避免由于直接执行底层工具导致的环境与配置问题。
*   **Git 只读默认**：AI 默认只允许执行 Git 只读命令（如 `git status`、`git diff`、`git log`、`git show`、`git blame`）。除非用户明确授权，否则严禁执行任何会修改 Git 状态的命令（如 `git add`、`git commit`、`git stash`、`git reset`、`git checkout`、`git rebase`、`git merge`、`git cherry-pick`、`git tag`、`git push`、`git pull` 等）。
*   **状态同步机制**：严禁一边修改代码一边运行 `just check`。应在逻辑修改完成后统一提交检查，避免开发进程混乱。
*   **指令执行耐心**：必须耐心等待，确保命令明确运行完毕，再进行下一步操作。严禁在命令执行期间或尚未完成时，擅自作出错误判断并盲目修改代码，避免造成逻辑混乱。
*   **串行验证顺序**：
    1.  先运行 `just check`：确保类型安全和语法正确，这能有效节约编译与调试时间。
    2.  待 `check` 完全通过后，方可运行 `just test` 进行逻辑验证。

## 4. 架构设计与代码质量
*   **代码品味（Taste）**：
    *   **拒绝兼容层**：兼容层会污染代码质量。本项目倾向于破坏性更新（Breaking Changes）以追求最佳实践，除非有极度明确的理由，否则不准搞脏代码。
    *   **唯一性原则**：代码应保持唯一的用法和写法。不要兼容旧代码或保留冗余的回退逻辑，代码质量永远优先。
    *   **清晰优雅可读**：实现应优先选择语义直观、层次清晰、命名准确的写法；避免炫技式技巧、隐式行为和过度嵌套，确保审阅者能快速理解核心逻辑。
    *   **大文件拆分约束**：拆分大文件，单个文件代码行数尽量不超过 300 行，以提高可维护性和可读性。
*   **类型系统约束**：
    *   **Rust 为源头**：所有核心类型在 Rust 端定义，利用 `pyo3-stub-gen` 自动生成 Python 的 `.pyi` 类型存根。
    *   **禁止镜像维护**：Python 侧不得再维护与 Rust 对应的镜像输入/输出类型文件；类型变更必须先改 Rust，再通过 `just stub` / `just check` 同步存根与静态检查。
    *   **Python 端强类型**：对于大型项目，Python 侧应尽可能结合 **Pydantic** 进行类型声明，确保项目的健壮性与稳定性。

## 5. 技术指标对齐标准
*   **基准对齐**：回测引擎中的指标实现必须严格以 **`pandas-ta` (talib=true)** 模式为准。所有指标实现必须通过与之对齐的严格测试。
*   **库优先级**：`pandas-ta` (talib=true) > `pandas-ta` (talib=false)。禁止直接使用原始的 `talib` 库。
*   **调用规范**：禁止使用类似 `ohlc.ta.atr(talib=True)` 的调用方式。应统一采用 `import pandas_ta as ta; ta.atr(...)`。
*   **版本背景与警告**：
    *   **优先使用旧版 `pandas-ta`**：原版 `pandas-ta` 已不再更新且已被作者删库闭源。本项目目前使用的是该库的一个不再更新的**备份旧版**，它是我们指标对齐的基准，必须优先使用。
    *   **慎用 `pandas-ta-classic`**：这是社区基于原版 Fork 的新版，但其内部包含大量未经验证的效果修改。除非备份旧版中确实缺失某个指标，否则不要使用新版（Classic），以防止测试失败或回测结果发生不可解释的漂移。

## 6. 异常处理与防御原则
*   **拒绝异常吞噬**：严禁滥用 `try: except Exception: pass`。异常捕捉必须精细化，或至少打印详细的项目报错日志。
*   **拒绝冗长防御**：不搞过度复杂的防御性编程。本项目推崇直接报错（Exception），通过明确的报错约束来引导用户使用唯一的正确写法。
*   **明确性胜过容错**：在回测引擎中，不搞折中的回退逻辑或警告，直接报错是保证逻辑唯一性与系统稳健性的最佳方式。

## 7. Notebook 与策略脚本分层设计
*   **职责分离**：`.py` 是给 AI 调试的，`ipynb` 是给人调试的。
*   **AI 调试入口**：`.py` 必须实现 `__main__`，并输出可读结果，供 AI 查看和调试。
*   **AI 读取约束**：AI 默认不得直接读取 `ipynb`；只有在用户给出明确指令时，才允许读取 `ipynb` 内容。
*   **Notebook 调用入口**：`.py` 中的策略封装函数（如 `run_xxx_backtest()`）是给 `ipynb` 导入和调用的。
*   **示例路径**：
    *   `.py`：`py_entry/example/custom_backtest.py`
    *   `.ipynb`：`py_entry/example/custom_backtest.ipynb`
